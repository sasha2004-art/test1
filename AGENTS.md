# AI_AGENT.md: AI Quest Generator

## 1. Миссия

Автономно исправлять и расширять кодовую базу проекта **AI Quest Generator**, строго придерживаясь его основополагающих аксиом.

## 2. Аксиомы (Основные Принципы)

Перед началом любой работы изучите и примите эти аксиомы. Они являются законом.

*   **A1: Корректность, доказанная тестами и типами.** Любые изменения должны проходить все тесты. Весь новый код должен быть типизирован.
*   **A2: Читаемость за ≤ 60 секунд.** Код должен быть интуитивно понятным для других разработчиков.
*   **A3: Единый источник истины.** Избегайте дублирования кода и конфигураций. Используйте переменные окружения для конфигурации, где это применимо.
*   **A4: Быстрое и громкое падение.** Ошибки должны быть явными и приводить к немедленной остановке, а не к непредсказуемому поведению.
*   **A5: Маленькие, сфокусированные единицы.** Функции, классы и коммиты должны иметь одну четкую зону ответственности.
*   **A6: Чистое ядро, нечистые границы.** Основная бизнес-логика (в `app/services/`) не должна зависеть от внешних систем, таких как `pywebview` или API конкретных LLM.
*   **A7: Детерминированные сборки.** Процесс установки зависимостей должен быть воспроизводимым.
*   **A8: Непрерывная проверка.** Всегда запускайте скрипт верификации `python scripts/verify.py` перед созданием коммита.
*   **A9: Безопасные значения по умолчанию.** Приложение должно запускаться и функционировать в безопасном режиме без сложной предварительной настройки.
*   **A10: Контроль версий всего.** Код, документация (`docs/`) и данный файл (`AGENTS.md`) находятся под управлением Git.

## 3. Цикл Рабочего Процесса и Правила Взаимодействия

### 3.1. Общий Цикл
Для каждого изменения необходимо следовать этому циклу:
**ИССЛЕДОВАНИЕ → ПЛАНИРОВАНИЕ → ДЕЙСТВИЕ → НАБЛЮДЕНИЕ → РАЗМЫШЛЕНИЕ → КОММИТ**

#### 3.1.1. ИССЛЕДОВАНИЕ (Exploration)
Этот этап посвящен полному пониманию задачи, текущего состояния проекта и его архитектуры.
1.  **Понимание Задачи:** Внимательно прочитайте предоставленный промпт или описание задачи. Убедитесь, что вы полностью понимаете требуемый функционал или исправляемую ошибку.
2.  **Анализ Аксиом:** Перечитайте и усвойте все Аксиомы (пункт 2). Они должны стать вашим руководством на протяжении всего цикла.
3.  **Обзор Проекта (Инвентаризация):**
    *   Используйте команды `ls -1`, `tree` для получения общего представления о структуре проекта.
    *   Определите основной язык (Python) и ключевые файлы зависимостей (`requirements.txt`).
    *   Ознакомьтесь с основными точками входа (например, маршруты Flask через `rg --type py '@app.route' app/`) и архитектурными маркерами (`docker/docker-compose.yml`, `docker/Dockerfile`, `app/main.py`).
4.  **Изучение Соответствующих Файлов:**
    *   Определите файлы и модули, которые, вероятно, будут затронуты изменениями.
    *   Прочитайте их содержимое, чтобы понять их назначение, логику и взаимодействие с другими частями системы.
    *   Особое внимание уделите контрактам данных
5.  **Анализ Существующих Тестов:** Изучите тесты, связанные с затрагиваемыми модулями (`rg --type py 'def test_' tests/`). Это поможет понять ожидаемое поведение и как можно будет проверить ваши изменения.
6.  **Определение Стиля и Шаблонов:** Проанализируйте существующий код на предмет используемого стиля форматирования (`black`), соглашений об именовании, архитектурных шаблонов и подходов. Ваше решение должно гармонировать с уже существующим кодом (A2).
7.  **Формулирование Проблемы/Цели:** На основе исследования, четко сформулируйте проблему, которую вы решаете, или функционал, который добавляете.

#### 3.1.2. ПЛАНИРОВАНИЕ (Planning)
На этом этапе вы разрабатываете детальный план решения задачи, учитывая все аксиомы и результаты исследования.
1.  **Создание Ветки Git:** Перед началом любых изменений, создайте новую ветку Git. Имя ветки должно быть описательным и следовать соглашению (например, `feature/add-new-llm`, `fix/json-validation-bug`).
2.  **Декомпозиция Задачи:** Разбейте основную задачу на более мелкие, атомарные подзадачи. Каждая подзадача должна быть четко определена и управляема (A5).
3.  **Выбор Подхода:** Определите наилучший способ решения каждой подзадачи. Рассмотрите различные варианты и выберите тот, который наилучшим образом соответствует аксиомам (особенно A1, A2, A3, A6).
4.  **Список Изменений:** Составьте список файлов, которые будут изменены, созданы или удалены.
5.  **Стратегия Тестирования:**
    *   Определите, какие новые тесты необходимо написать для проверки вашего кода.
    *   Решите, какие существующие тесты могут потребовать обновления.
    *   Убедитесь, что ваш план включает достижение высокого покрытия кода (не менее 90% для Pytest).
6.  **Проверка Аксиом в Плане:** Проверьте свой план на соответствие всем аксиомам:
    *   Как будет обеспечена корректность (A1)?
    *   Как будет сохранена читаемость (A2)?
    *   Как будет избегаться дублирование (A3)?
    *   Как будут обрабатываться ошибки (A4)?
    *   Являются ли единицы кода маленькими и сфокусированными (A5)?
    *   Как будет соблюдаться чистота ядра (A6)?
7.  **Псевдокод/Эскиз:** Если это сложная задача, набросайте псевдокод или высокоуровневую диаграмму, чтобы визуализировать потоки данных и логику.

#### 3.1.3. ДЕЙСТВИЕ (Action)
Это этап непосредственной реализации вашего плана.
1.  **Импортируйте Изменения:** Последовательно реализуйте изменения, следуя разработанному плану.
2.  **Пишите Тесты Параллельно:** Для каждой новой функции или изменения существующей логики, напишите или обновите соответствующие тесты *до или одновременно* с написанием рабочего кода (принцип TDD - Test-Driven Development). Это помогает гарантировать корректность (A1).
3.  **Придерживайтесь Стиля Кода:** Пишите код, который полностью соответствует существующему стилю проекта (Black, Flake8) и легко читаем (A2).
4.  **Добавляйте Типы:** Весь новый код должен быть типизирован с использованием аннотаций типов Python (A1).
5.  **Маленькие, Сфокусированные Изменения:** Старайтесь делать изменения небольшими и сфокусированными. Если задача большая, разбивайте ее на несколько логических, атомарных шагов (A5).
6.  **Избегайте Дублирования:** Активно ищите и устраняйте дублирование кода или конфигураций (A3).
7.  **Обработка Ошибок:** Реализуйте механизмы обработки ошибок, которые приводят к быстрому и громкому падению при неожиданных состояниях (A4).

#### 3.1.4. НАБЛЮДЕНИЕ (Observation)
На этом этапе вы проверяете результаты своих действий.
1.  **Локальный Запуск Тестов (при необходимости):** Запустите тесты, которые вы написали или изменили: `python -m pytest tests/<ваш_модуль_тестов>.py`.
2.  **Полная Верификация Проекта:** Запустите универсальный скрипт верификации. **Это обязательный шаг.**
    ```bash
    python scripts/verify.py
    ```
3.  **Анализ Вывода:** Внимательно проанализируйте весь вывод скрипта.
    *   Прошли ли Black, Flake8, Pyright, Pip-audit, Bandit, Semgrep?
    *   Все ли тесты Pytest пройдены? Достигнуто ли покрытие кода не менее 90%?
4.  **Ручная Проверка:** Запустите десктопное приложение (`python run_desktop.py`) и вручную проверьте, что все изменения работают корректно в UI.
5.  **Идентификация Проблем:** Если какой-либо шаг верификации или ручной проверки завершился неудачей, четко идентифицируйте проблему:
    *   Ошибка форматирования?
    *   Ошибка линтинга?
    *   Ошибка типа?
    *   Уязвимость?
    *   Непройденный тест?
    *   Неожиданное поведение в UI/API?

#### 3.1.5. РАЗМЫШЛЕНИЕ (Reflection)
Этот этап является критически важным для обучения и улучшения.
1.  **Анализ Неудач:** Если в этапе НАБЛЮДЕНИЕ были обнаружены проблемы:
    *   Почему они возникли? Была ли ошибка в планировании, реализации или понимании?
    *   Как их можно исправить?
    *   Вернитесь к этапу ДЕЙСТВИЕ, чтобы внести исправления, или, если проблема фундаментальна, даже к ПЛАНИРОВАНИЮ.
2.  **Оценка Качества Кода:** Даже если все тесты прошли и `verify.sh` чист, задайте себе вопросы:
    *   Насколько мой код соответствует аксиомам A2 (Читаемость), A3 (Единый источник истины), A5 (Маленькие единицы), A6 (Чистое ядро)?
    *   Можно ли улучшить читаемость, упростить логику, уменьшить дублирование?
    *   Является ли решение наиболее элегантным и эффективным?
3.  **Рефакторинг (при необходимости):** Внесите улучшения, если они необходимы для соблюдения аксиом или повышения общего качества кода, даже если текущее решение "работает". Это может быть переход от этапа РАЗМЫШЛЕНИЕ обратно к ДЕЙСТВИЕ, а затем снова НАБЛЮДЕНИЕ.
4.  **Документирование:** Если изменения сложны или требуют особого внимания, обновите или добавьте необходимую документацию (`docs/`).

#### 3.1.6. КОММИТ (Commit)
Финальный этап, фиксирующий вашу работу.
1.  **Финальная Верификация:** **Обязательно** запустите `python scripts/verify.py` еще раз, чтобы убедиться, что все изменения не нарушили ни одного правила.
2.  **Чистота Рабочей Директории:** Убедитесь, что команда `git status` показывает, что нет несохраненных изменений, кроме тех, которые вы хотите закоммитить (пустые строки или временные файлы должны быть удалены).
3.  **Индексирование Изменений:** Используйте `git add .` (или выборочно `git add <файл>`) для добавления всех необходимых изменений в индекс Git.
4.  **Создание Коммита:** Используйте `git commit -m "Ваше_сообщение_коммита"` для фиксации атомарных изменений. Сообщение коммита должно быть четким, кратким и отражать суть сделанных изменений (A5).
    *   **Запомните:** Не используйте `git commit --amend` или `git rebase`.
5.  **Цитирование:** При создании Pull Request или финального отчета, добавьте цитаты, ссылаясь на использованные файлы или выводы терминала, согласно формату:
    *   **Формат для файлов:** `【F:<file_path>†L<line_start>(-L<line_end>)?】`
        *   *Пример:* Этот код инициализирует Flask-приложение【F:app/main.py†L5】.
    *   **Формат для терминала:** `【<chunk_id>†L<line_start>(-L<line_end>)?】`
        *   *Пример:* Все тесты успешно пройдены【terminal_output_1†L5】.
6.  **Отправка Ветки:** После успешного коммита, отправьте ветку на удаленный репозиторий: `git push origin <имя_вашей_ветки>`.

### 3.2. Работа с Git
*   **Работайте в отдельных ветках.** Имя ветки должно отражать суть задачи и следовать соглашению (например, `feature/add-new-llm`, `fix/json-validation-bug`).
*   **Коммитьте свои изменения.** Используйте `git commit` для фиксации атомарных изменений. Оцениваться будет только закоммиченный код.
*   **Исправляйте ошибки pre-commit.** Если хуки `pre-commit` завершаются с ошибкой, исправьте проблемы и повторите коммит.
*   **Поддерживайте чистоту рабочей директории.** После коммита команда `git status` должна показывать, что в рабочей директории нет несохраненных изменений.
*   **Не изменяйте существующие коммиты.** Не используйте команды `git commit --amend` или `git rebase`.

### 3.3. Интерпретация `AGENTS.md`
*   **Область действия:** Инструкции этого файла распространяются на всю директорию проекта.
*   **Приоритет:** Инструкции от пользователя (в промпте) имеют наивысший приоритет над этим файлом.
*   **Обязательные проверки:** Если этот файл содержит инструкции по программным проверкам (например, запуск скрипта `./scripts/verify.sh`), вы ОБЯЗАНЫ запустить их все и убедиться в их успешном прохождении ПОСЛЕ внесения всех изменений.

### 3.4. Цитирование
Вы должны добавлять цитаты к своему финальному ответу (например, в описании Pull Request), ссылаясь на использованные файлы или выводы терминала. **Это необходимо для обеспечения полной прозрачности и отслеживаемости ваших действий во время ревью.**

*   **Формат для файлов:** `【F:<file_path>†L<line_start>(-L<line_end>)?】`
    *   *Пример:* Этот код инициализирует Flask-приложение【F:app/main.py†L5】.
*   **Формат для терминала:** `【<chunk_id>†L<line_start>(-L<line_end>)?】`
    *   *Пример:* Все тесты успешно пройденy【terminal_output_1†L5】.

## 4. Настройка Среды

Проект представляет собой десктопное приложение, написанное на Python с использованием PyWebView.

### 4.1. Первичная Настройка
1.  Убедитесь, что у вас установлен **Python 3.10+**.
2.  Для корректной сборки `llama-cpp-python` на Windows вам могут потребоваться **Visual Studio Build Tools** (с компонентом "C++ desktop development") и **NVIDIA CUDA Toolkit** (если у вас есть GPU NVIDIA).
3.  Запустите скрипт `start.py` из корневой папки проекта:
    ```bash
    python start.py
    ```
    Этот скрипт автоматически:
    *   Создаст виртуальное окружение `.venv`.
    *   Установит все необходимые зависимости из `requirements.txt`.
    *   Попытается установить `llama-cpp-python` с поддержкой GPU.
    *   Запустит десктопное приложение.

### 4.2. Последующие Запуски
После первой настройки вы можете просто запускать приложение напрямую:
```bash
python run_desktop.py
```
Или, если вы предпочитаете работать в активированном окружении:
```bash
# Windows
.venv\Scripts\activate
# Linux/macOS
source .venv/bin/activate

# Затем запуск
python run_desktop.py
```

### 4.3. Проверка Качества Кода
Перед каждым коммитом **обязательно** запускайте универсальный скрипт верификации. Он выполняет 7 ключевых проверок (форматирование, линтинг, типы, безопасность, тесты).
```bash
python scripts/verify.py
```
**Если любой из шагов завершается неудачей, остановитесь, проанализируйте вывод и исправьте проблему.**
Успешное выполнение этого скрипта является обязательным условием для завершения любой задачи.